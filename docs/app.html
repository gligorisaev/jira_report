<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requirements Traceability Dashboard</title>
    <script src="chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #718096;
            font-size: 16px;
            margin-top: 5px;
        }
        
        .header .timestamp {
            color: #a0aec0;
            font-size: 14px;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* Upload Zone */
        .upload-section {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .upload-zone {
            border: 3px dashed #cbd5e0;
            border-radius: 10px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: #f7fafc;
        }
        
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #667eea;
            background: #edf2f7;
        }
        
        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
            color: #667eea;
        }
        
        .upload-zone h2 {
            color: #2d3748;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .upload-zone p {
            color: #718096;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .upload-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .upload-button:hover {
            transform: translateY(-2px);
        }
        
        .file-input {
            display: none;
        }
        
        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: #e6fffa;
            border-radius: 8px;
            color: #234e52;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .error-message {
            margin-top: 20px;
            padding: 15px;
            background: #fed7d7;
            border-radius: 8px;
            color: #742a2a;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* Dashboard sections - hidden until file is loaded */
        .dashboard-content {
            display: none;
        }
        
        .dashboard-content.show {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card.highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stat-card .label {
            font-size: 14px;
            color: #718096;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card.highlight .label {
            color: rgba(255,255,255,0.9);
        }
        
        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .stat-card.highlight .value {
            color: white;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .chart-card h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .epics-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .epic-card {
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s;
        }
        
        .epic-card:last-child {
            border-bottom: none;
        }
        
        .epic-header {
            padding: 20px 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .epic-header:hover {
            background: #f7fafc;
        }
        
        .epic-title {
            flex: 1;
        }
        
        .epic-key {
            font-weight: bold;
            color: #667eea;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .epic-summary {
            color: #2d3748;
            font-size: 16px;
        }
        
        .epic-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge.stories {
            background: #e6fffa;
            color: #234e52;
        }
        
        .badge.tests {
            background: #faf5ff;
            color: #553c9a;
        }
        
        .badge.coverage-high {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .badge.coverage-medium {
            background: #feebc8;
            color: #7c2d12;
        }
        
        .badge.coverage-low {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .badge.no-stories {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .expand-icon {
            color: #cbd5e0;
            font-size: 20px;
            transition: transform 0.3s;
        }
        
        .epic-card.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .epic-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .epic-card.expanded .epic-content {
            max-height: 5000px;
        }
        
        .epic-details {
            padding: 0 25px 25px 25px;
            background: #f7fafc;
        }
        
        .stories-list {
            margin-top: 15px;
        }
        
        .story-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .story-item.covered {
            border-left-color: #48bb78;
        }
        
        .story-item.uncovered {
            border-left-color: #f56565;
        }
        
        .story-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .story-key {
            font-weight: 600;
            color: #667eea;
            font-size: 13px;
        }
        
        .story-summary {
            color: #4a5568;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .tests-list {
            margin-top: 10px;
            padding-left: 20px;
        }
        
        .test-item {
            padding: 8px 12px;
            background: #f7fafc;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        .test-key {
            font-weight: 600;
            color: #553c9a;
            margin-right: 10px;
        }
        
        .test-summary {
            flex: 1;
            color: #4a5568;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.passed {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-badge.failed {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .status-badge.notrun {
            background: #feebc8;
            color: #7c2d12;
        }
        
        .status-badge.todo {
            background: #e6fffa;
            color: #234e52;
        }
        
        .no-tests {
            color: #a0aec0;
            font-style: italic;
            font-size: 13px;
            padding: 10px;
        }
        
        .search-box {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .view-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .view-tab {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: #f7fafc;
            color: #4a5568;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-tab:hover {
            background: #edf2f7;
        }
        
        .view-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .view-content {
            display: none;
        }
        
        .view-content.active {
            display: block;
        }
        
        .tests-view {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .test-group {
            border-bottom: 1px solid #e2e8f0;
        }
        
        .test-group:last-child {
            border-bottom: none;
        }
        
        .test-group-header {
            padding: 20px 25px;
            background: #f7fafc;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .test-group-header:hover {
            background: #edf2f7;
        }
        
        .test-group-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-parent-info {
            flex: 1;
        }
        
        .test-epic {
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .test-story {
            font-size: 14px;
            color: #2d3748;
            font-weight: 600;
        }
        
        .test-count-badge {
            background: #faf5ff;
            color: #553c9a;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .test-group-tests {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .test-group.expanded .test-group-tests {
            max-height: 3000px;
        }
        
        .test-group-tests-inner {
            padding: 0 25px 25px 25px;
        }
        
        .orphan-tests {
            background: #fef5e7;
            border-left: 4px solid #f39c12;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" id="mainHeader">
            <h1 id="dashboardTitle">üìä Requirements Traceability Dashboard</h1>
            <p class="subtitle" id="dashboardSubtitle">Upload your Jira Requirements Traceability Report to generate an interactive dashboard</p>
            <p class="timestamp" id="dashboardTimestamp"></p>
        </div>
        
        <div class="upload-section">
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÇ</div>
                <h2>Drop your CSV file here</h2>
                <p>or click to browse</p>
                <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                    Choose File
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".csv" onchange="handleFileSelect(event)">
            </div>
            <div class="file-info" id="fileInfo"></div>
            <div class="error-message" id="errorMessage"></div>
        </div>
        
        <div class="dashboard-content" id="dashboardContent">
            <div class="stats-grid" id="statsGrid"></div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <h3>üìà Coverage Overview</h3>
                    <canvas id="coverageChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>üß™ Test Status Distribution</h3>
                    <canvas id="testsChart"></canvas>
                </div>
            </div>
            
            <div class="view-tabs">
                <button class="view-tab active" onclick="switchView('epics')">üìä Epics View</button>
                <button class="view-tab" onclick="switchView('tests')">üß™ Tests View</button>
            </div>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Search epics, stories, or tests...">
            </div>
            
            <div class="view-content active" id="epicsView">
                <div class="epics-container" id="epicsContainer"></div>
            </div>
            
            <div class="view-content" id="testsView">
                <div class="tests-view" id="testsContainer"></div>
            </div>
        </div>
    </div>
    
    <script>
        let coverageChart = null;
        let testsChart = null;
        
        // Drag and drop handlers
        const uploadZone = document.getElementById('uploadZone');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => {
                uploadZone.classList.add('dragover');
            });
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => {
                uploadZone.classList.remove('dragover');
            });
        });
        
        uploadZone.addEventListener('drop', handleDrop);
        uploadZone.addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }
        
        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showError('Please select a CSV file');
                return;
            }
            
            showFileInfo(file.name);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const uploadTime = new Date();
                    processCSV(content, file.name, uploadTime);
                } catch (error) {
                    showError('Error processing file: ' + error.message);
                }
            };
            reader.onerror = function() {
                showError('Error reading file');
            };
            reader.readAsText(file);
        }
        
        function showFileInfo(filename) {
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.textContent = `‚úì Loaded: ${filename}`;
            fileInfo.classList.add('show');
            document.getElementById('errorMessage').classList.remove('show');
        }
        
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = `‚ö†Ô∏è ${message}`;
            errorMessage.classList.add('show');
            document.getElementById('fileInfo').classList.remove('show');
        }
        
        function naturalSortKey(text) {
            const parts = [];
            const regex = /(\d+)/g;
            let match;
            let lastIndex = 0;
            
            while ((match = regex.exec(text)) !== null) {
                if (match.index > lastIndex) {
                    parts.push(text.substring(lastIndex, match.index).toLowerCase());
                }
                parts.push(parseInt(match[1]));
                lastIndex = regex.lastIndex;
            }
            
            if (lastIndex < text.length) {
                parts.push(text.substring(lastIndex).toLowerCase());
            }
            
            return parts;
        }
        
        function parseCSV(content) {
            const lines = content.split(/\r?\n/);
            if (lines.length === 0) return [];
            
            const headers = lines[0].split(';').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = line.split(';');
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = (values[index] || '').trim();
                });
                
                data.push(row);
            }
            
            return data;
        }
        
        function processCSV(content, fileName, uploadTime) {
            const rows = parseCSV(content);
            
            if (rows.length === 0) {
                showError('CSV file is empty or invalid');
                return;
            }
            
            // Extract project name from first row with data
            let projectName = 'Project';
            for (const row of rows) {
                const projectKey = row['Project key'] || '';
                const projectNameField = row['Project name'] || '';
                if (projectKey || projectNameField) {
                    projectName = projectNameField || projectKey;
                    break;
                }
                // If no project field, extract from issue key (e.g., TML40 from TML40-531)
                const reqKey = row['Requirement Key'] || '';
                if (reqKey) {
                    const parts = reqKey.split('-');
                    if (parts.length >= 2) {
                        projectName = parts[0];
                        break;
                    }
                }
            }
            
            // Build data structures
            const epics = {};
            const stories = {};
            const tests = {};
            
            rows.forEach(row => {
                const parentKey = row['Parent Requirement Key'] || '';
                const parentSummary = row['Parent Requirement Summary'] || '';
                const reqKey = row['Requirement Key'] || '';
                const reqSummary = row['Requirement Summary'] || '';
                const reqStatus = row['Requirement Status'] || '';
                const testKey = row['Test Key'] || '';
                const testSummary = row['Test Summary'] || '';
                const testStatus = row['Test Status'] || '';
                
                // Handle epics
                if (parentKey && !epics[parentKey]) {
                    epics[parentKey] = {
                        summary: parentSummary,
                        stories: {}
                    };
                }
                
                // Handle stories
                if (reqKey) {
                    if (parentKey) {
                        if (!stories[reqKey]) {
                            stories[reqKey] = {
                                epicKey: parentKey,
                                summary: reqSummary,
                                status: reqStatus,
                                tests: {}
                            };
                        }
                        
                        if (epics[parentKey] && !epics[parentKey].stories[reqKey]) {
                            epics[parentKey].stories[reqKey] = {
                                summary: reqSummary,
                                status: reqStatus,
                                tests: {}
                            };
                        }
                    } else {
                        // Story without parent is itself an epic
                        if (!epics[reqKey]) {
                            epics[reqKey] = {
                                summary: reqSummary,
                                stories: {}
                            };
                        }
                    }
                }
                
                // Handle tests
                if (testKey && reqKey) {
                    const statusUpper = testStatus.toUpperCase();
                    let normalizedStatus = 'TO DO';
                    
                    if (statusUpper.includes('PASS') || statusUpper === 'DONE') {
                        normalizedStatus = 'PASSED';
                    } else if (statusUpper.includes('FAIL')) {
                        normalizedStatus = 'FAILED';
                    } else if (statusUpper.includes('NOTRUN') || statusUpper.includes('NOT RUN')) {
                        normalizedStatus = 'NOTRUN';
                    }
                    
                    if (!tests[testKey]) {
                        tests[testKey] = {
                            summary: testSummary,
                            status: normalizedStatus,
                            stories: new Set()
                        };
                    }
                    
                    tests[testKey].stories.add(reqKey);
                    
                    if (stories[reqKey]) {
                        stories[reqKey].tests[testKey] = {
                            summary: testSummary,
                            status: normalizedStatus
                        };
                        
                        const epicKey = stories[reqKey].epicKey;
                        if (epics[epicKey] && epics[epicKey].stories[reqKey]) {
                            epics[epicKey].stories[reqKey].tests[testKey] = {
                                summary: testSummary,
                                status: normalizedStatus
                            };
                        }
                    } else if (epics[reqKey]) {
                        if (!epics[reqKey]._directTests) {
                            epics[reqKey]._directTests = {};
                        }
                        epics[reqKey]._directTests[testKey] = {
                            summary: testSummary,
                            status: normalizedStatus
                        };
                    }
                }
            });
            
            // Calculate metrics and render
            const metrics = calculateMetrics(epics);
            updateDashboardTitle(projectName, fileName, uploadTime);
            renderDashboard(epics, metrics, stories, tests);
        }
        
        function updateDashboardTitle(projectName, fileName, uploadTime) {
            const titleEl = document.getElementById('dashboardTitle');
            const subtitleEl = document.getElementById('dashboardSubtitle');
            const timestampEl = document.getElementById('dashboardTimestamp');
            
            titleEl.textContent = `üìä ${projectName} - Requirements Traceability`;
            subtitleEl.textContent = `Source: ${fileName}`;
            
            const formattedTime = uploadTime.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            timestampEl.textContent = `Generated: ${formattedTime}`;
        }
        
        function calculateMetrics(epics) {
            const metrics = {};
            
            Object.keys(epics).forEach(epicKey => {
                const epic = epics[epicKey];
                const totalStories = Object.keys(epic.stories).length;
                const coveredStories = Object.values(epic.stories).filter(s => Object.keys(s.tests).length > 0).length;
                const uncoveredStories = totalStories - coveredStories;
                
                const testCounts = { PASSED: 0, FAILED: 0, NOTRUN: 0, 'TO DO': 0 };
                const seenTests = new Set();
                
                Object.values(epic.stories).forEach(story => {
                    Object.entries(story.tests).forEach(([testKey, test]) => {
                        if (!seenTests.has(testKey)) {
                            seenTests.add(testKey);
                            testCounts[test.status] = (testCounts[test.status] || 0) + 1;
                        }
                    });
                });
                
                if (epic._directTests) {
                    Object.entries(epic._directTests).forEach(([testKey, test]) => {
                        if (!seenTests.has(testKey)) {
                            seenTests.add(testKey);
                            testCounts[test.status] = (testCounts[test.status] || 0) + 1;
                        }
                    });
                }
                
                const totalTests = seenTests.size;
                const coveragePercent = totalStories > 0 ? (coveredStories / totalStories * 100) : 0;
                
                metrics[epicKey] = {
                    totalStories,
                    coveredStories,
                    uncoveredStories,
                    coveragePercent,
                    totalTests,
                    passedTests: testCounts.PASSED || 0,
                    failedTests: testCounts.FAILED || 0,
                    notrunTests: testCounts.NOTRUN || 0,
                    todoTests: testCounts['TO DO'] || 0
                };
            });
            
            return metrics;
        }
        
        function renderDashboard(epics, metrics, stories, tests) {
            // Calculate overall stats
            const totalEpics = Object.keys(epics).length;
            const totalStories = Object.values(metrics).reduce((sum, m) => sum + m.totalStories, 0);
            const coveredStories = Object.values(metrics).reduce((sum, m) => sum + m.coveredStories, 0);
            const totalTests = Object.keys(tests).length; // Count unique tests globally
            
            // Count test statuses from unique tests
            const passedTests = Object.values(tests).filter(t => t.status === 'PASSED').length;
            const failedTests = Object.values(tests).filter(t => t.status === 'FAILED').length;
            const notrunTests = Object.values(tests).filter(t => t.status === 'NOTRUN').length;
            const todoTests = Object.values(tests).filter(t => t.status === 'TO DO').length;
            const overallCoverage = totalStories > 0 ? (coveredStories / totalStories * 100) : 0;
            
            // Render stats
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card highlight">
                    <div class="label">Total Epics</div>
                    <div class="value">${totalEpics}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Total Stories</div>
                    <div class="value">${totalStories}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Covered Stories</div>
                    <div class="value">${coveredStories}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Coverage</div>
                    <div class="value">${overallCoverage.toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="label">Total Tests</div>
                    <div class="value">${totalTests}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Passed</div>
                    <div class="value">${passedTests}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Failed</div>
                    <div class="value">${failedTests}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Not Run</div>
                    <div class="value">${notrunTests}</div>
                </div>
            `;
            
            // Render charts
            renderCharts(coveredStories, totalStories - coveredStories, passedTests, failedTests, notrunTests, todoTests);
            
            // Render epics
            renderEpics(epics, metrics);
            
            // Render tests view
            renderTestsView(epics, stories, tests);
            
            // Show dashboard
            document.getElementById('dashboardContent').classList.add('show');
            
            // Setup search
            setupSearch();
        }
        
        function switchView(viewName) {
            // Update tabs
            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update views
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.remove('active');
            });
            
            if (viewName === 'epics') {
                document.getElementById('epicsView').classList.add('active');
            } else if (viewName === 'tests') {
                document.getElementById('testsView').classList.add('active');
            }
        }
        
        function renderCharts(covered, uncovered, passed, failed, notrun, todo) {
            const coverageCtx = document.getElementById('coverageChart').getContext('2d');
            const testsCtx = document.getElementById('testsChart').getContext('2d');
            
            if (coverageChart) coverageChart.destroy();
            if (testsChart) testsChart.destroy();
            
            coverageChart = new Chart(coverageCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Covered Stories', 'Uncovered Stories'],
                    datasets: [{
                        data: [covered, uncovered],
                        backgroundColor: ['#48bb78', '#f56565'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            testsChart = new Chart(testsCtx, {
                type: 'bar',
                data: {
                    labels: ['Passed', 'Failed', 'Not Run', 'To Do'],
                    datasets: [{
                        label: 'Tests',
                        data: [passed, failed, notrun, todo],
                        backgroundColor: ['#48bb78', '#f56565', '#ed8936', '#4299e1'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        function renderEpics(epics, metrics) {
            const epicsContainer = document.getElementById('epicsContainer');
            
            // Sort epics
            const sortedEpics = Object.entries(epics).sort((a, b) => {
                const keyA = naturalSortKey(a[1].summary);
                const keyB = naturalSortKey(b[1].summary);
                
                for (let i = 0; i < Math.min(keyA.length, keyB.length); i++) {
                    if (keyA[i] !== keyB[i]) {
                        if (typeof keyA[i] === 'number' && typeof keyB[i] === 'number') {
                            return keyA[i] - keyB[i];
                        }
                        return keyA[i] < keyB[i] ? -1 : 1;
                    }
                }
                return keyA.length - keyB.length;
            });
            
            let html = '';
            
            sortedEpics.forEach(([epicKey, epic]) => {
                const m = metrics[epicKey];
                
                let coverageBadge;
                if (m.totalStories === 0) {
                    coverageBadge = '<span class="badge no-stories">No Stories</span>';
                } else {
                    let coverageClass = 'coverage-low';
                    if (m.coveragePercent >= 80) coverageClass = 'coverage-high';
                    else if (m.coveragePercent >= 50) coverageClass = 'coverage-medium';
                    coverageBadge = `<span class="badge ${coverageClass}">${m.coveragePercent.toFixed(0)}%</span>`;
                }
                
                html += `
                    <div class="epic-card">
                        <div class="epic-header" onclick="toggleEpic(this)">
                            <div class="epic-title">
                                <div class="epic-key">${epicKey}</div>
                                <div class="epic-summary">${epic.summary}</div>
                            </div>
                            <div class="epic-stats">
                                <span class="badge stories">${m.totalStories} Stories</span>
                                <span class="badge tests">${m.totalTests} Tests</span>
                                ${coverageBadge}
                                <span class="expand-icon">‚ñº</span>
                            </div>
                        </div>
                        <div class="epic-content">
                            <div class="epic-details">
                `;
                
                if (m.totalStories > 0) {
                    html += '<div class="stories-list">';
                    
                    const sortedStories = Object.entries(epic.stories).sort((a, b) => {
                        const keyA = naturalSortKey(a[1].summary);
                        const keyB = naturalSortKey(b[1].summary);
                        
                        for (let i = 0; i < Math.min(keyA.length, keyB.length); i++) {
                            if (keyA[i] !== keyB[i]) {
                                if (typeof keyA[i] === 'number' && typeof keyB[i] === 'number') {
                                    return keyA[i] - keyB[i];
                                }
                                return keyA[i] < keyB[i] ? -1 : 1;
                            }
                        }
                        return keyA.length - keyB.length;
                    });
                    
                    sortedStories.forEach(([storyKey, story]) => {
                        const hasTests = Object.keys(story.tests).length > 0;
                        const coverageClass = hasTests ? 'covered' : 'uncovered';
                        
                        html += `
                            <div class="story-item ${coverageClass}">
                                <div class="story-header">
                                    <span class="story-key">${storyKey}</span>
                                    <span class="badge ${hasTests ? 'tests' : 'no-stories'}">${Object.keys(story.tests).length} Tests</span>
                                </div>
                                <div class="story-summary">${story.summary}</div>
                        `;
                        
                        if (hasTests) {
                            html += '<div class="tests-list">';
                            Object.entries(story.tests).forEach(([testKey, test]) => {
                                const statusLower = test.status.toLowerCase().replace(' ', '');
                                html += `
                                    <div class="test-item">
                                        <span class="test-key">${testKey}</span>
                                        <span class="test-summary">${test.summary}</span>
                                        <span class="status-badge ${statusLower}">${test.status}</span>
                                    </div>
                                `;
                            });
                            html += '</div>';
                        } else {
                            html += '<div class="no-tests">No tests linked to this story</div>';
                        }
                        
                        html += '</div>';
                    });
                    
                    html += '</div>';
                } else {
                    html += '<div class="no-tests">This epic has no stories</div>';
                }
                
                if (epic._directTests) {
                    html += '<div class="tests-list" style="margin-top: 15px;">';
                    html += '<div style="font-weight: 600; margin-bottom: 10px; color: #553c9a;">Direct Tests:</div>';
                    Object.entries(epic._directTests).forEach(([testKey, test]) => {
                        const statusLower = test.status.toLowerCase().replace(' ', '');
                        html += `
                            <div class="test-item">
                                <span class="test-key">${testKey}</span>
                                <span class="test-summary">${test.summary}</span>
                                <span class="status-badge ${statusLower}">${test.status}</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            epicsContainer.innerHTML = html;
        }
        
        function toggleEpic(header) {
            const epicCard = header.closest('.epic-card');
            epicCard.classList.toggle('expanded');
        }
        
        function renderTestsView(epics, stories, tests) {
            const testsContainer = document.getElementById('testsContainer');
            
            // Group tests by story
            const testsByStory = {};
            const orphanTests = [];
            
            Object.entries(tests).forEach(([testKey, test]) => {
                if (test.stories.size === 0) {
                    orphanTests.push({ key: testKey, ...test });
                } else {
                    test.stories.forEach(storyKey => {
                        if (!testsByStory[storyKey]) {
                            testsByStory[storyKey] = [];
                        }
                        testsByStory[storyKey].push({ key: testKey, ...test });
                    });
                }
            });
            
            // Sort stories by epic and story name
            const sortedStories = Object.entries(testsByStory).sort((a, b) => {
                const storyA = stories[a[0]];
                const storyB = stories[b[0]];
                
                if (!storyA || !storyB) return 0;
                
                // First sort by epic
                const epicCompare = (storyA.epicKey || '').localeCompare(storyB.epicKey || '');
                if (epicCompare !== 0) return epicCompare;
                
                // Then by story summary
                const summaryA = naturalSortKey(storyA.summary);
                const summaryB = naturalSortKey(storyB.summary);
                
                for (let i = 0; i < Math.min(summaryA.length, summaryB.length); i++) {
                    if (summaryA[i] !== summaryB[i]) {
                        if (typeof summaryA[i] === 'number' && typeof summaryB[i] === 'number') {
                            return summaryA[i] - summaryB[i];
                        }
                        return summaryA[i] < summaryB[i] ? -1 : 1;
                    }
                }
                return summaryA.length - summaryB.length;
            });
            
            let html = '';
            
            // Render stories with tests
            sortedStories.forEach(([storyKey, storyTests]) => {
                const story = stories[storyKey];
                if (!story) return;
                
                const epic = epics[story.epicKey];
                const epicSummary = epic ? epic.summary : 'Unknown Epic';
                
                html += `
                    <div class="test-group">
                        <div class="test-group-header" onclick="toggleTestGroup(this)">
                            <div class="test-group-info">
                                <div class="test-parent-info">
                                    <div class="test-epic">${story.epicKey} - ${epicSummary}</div>
                                    <div class="test-story">${storyKey}: ${story.summary}</div>
                                </div>
                                <div>
                                    <span class="test-count-badge">${storyTests.length} Tests</span>
                                </div>
                            </div>
                        </div>
                        <div class="test-group-tests">
                            <div class="test-group-tests-inner">
                `;
                
                storyTests.forEach(test => {
                    const statusLower = test.status.toLowerCase().replace(' ', '');
                    html += `
                        <div class="test-item">
                            <span class="test-key">${test.key}</span>
                            <span class="test-summary">${test.summary}</span>
                            <span class="status-badge ${statusLower}">${test.status}</span>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Render orphan tests (tests without stories)
            if (orphanTests.length > 0) {
                html += `
                    <div class="test-group orphan-tests">
                        <div class="test-group-header" onclick="toggleTestGroup(this)">
                            <div class="test-group-info">
                                <div class="test-parent-info">
                                    <div class="test-epic">‚ö†Ô∏è Orphan Tests</div>
                                    <div class="test-story">Tests without parent stories</div>
                                </div>
                                <div>
                                    <span class="test-count-badge">${orphanTests.length} Tests</span>
                                </div>
                            </div>
                        </div>
                        <div class="test-group-tests">
                            <div class="test-group-tests-inner">
                `;
                
                orphanTests.forEach(test => {
                    const statusLower = test.status.toLowerCase().replace(' ', '');
                    html += `
                        <div class="test-item">
                            <span class="test-key">${test.key}</span>
                            <span class="test-summary">${test.summary}</span>
                            <span class="status-badge ${statusLower}">${test.status}</span>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            }
            
            testsContainer.innerHTML = html;
        }
        
        function toggleTestGroup(header) {
            const group = header.closest('.test-group');
            group.classList.toggle('expanded');
        }
        
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                // Search in epics view
                const epicCards = document.querySelectorAll('#epicsView .epic-card');
                epicCards.forEach(card => {
                    const text = card.textContent.toLowerCase();
                    card.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
                
                // Search in tests view
                const testGroups = document.querySelectorAll('#testsView .test-group');
                testGroups.forEach(group => {
                    const text = group.textContent.toLowerCase();
                    group.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
            });
        }
    </script>
</body>
</html>
